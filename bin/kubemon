#!/usr/bin/env bash

# files=( /mnt/cart_k8s/secrets/kubectl/{cart-*,k8s-test}_config )
files=( /mnt/cart_k8s/secrets/kubectl/cart-*_config )
# files=( $HOME/.kube/config-nexus-* )

highlight() {
    sed -r "s/(CrashLoopBackOff|Error)/\\x1b[1;41m\0\\x1b[0m/g" | \
    sed -r "s/(Running)/\\x1b[1;42m\0\\x1b[0m/g"
}

half() {
    for i in $( seq $1 2 $(( ${#files[*]} - 1 )) ); do
        echo $( basename ${files[$i]} _config ) | figlet
        # KUBECONFIG=${files[$i]} kubectl get pods | highlight
        KUBECONFIG=${files[$i]} kubectl get pods
    done
}

get_output() {
    date

    # highlight comes last because column & cut are counting characters, but
    # highlight adds non-printing characters, which throws them off
    paste -d% <( half 0 2>&1 ) <( half 1 2>&1 ) | \
        column -t -s% -o ' | ' | \
        cut -c-$(tput cols) | \
        highlight
}

while true; do
    output="$( get_output )"
    clear
    echo "$output"
    sleep 5
done
