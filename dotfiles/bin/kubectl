#!/bin/bash

# wrapper around kubectl to allow setting context and namespace via environment variable

# first, find the real kubectl executable

this_file=$(readlink -f $0)
outer_kubectl=

# collect paths, preserving spaces
readarray -t items < <(which --all kubectl)

for item in "${items[@]}"; do
    full_item=$( readlink -f $item )
    if [[ $full_item != $this_file ]]; then
        outer_kubectl="$full_item"
        break
    fi
done

if [[ ! -x $outer_kubectl ]]; then
    echo >&2 "[X] kubectl not found"
    exit 1
fi

# then, build up our arguments for it
args=

if [[ -v KUBE_CONTEXT ]]; then
    args+=" --context=$KUBE_CONTEXT"
fi

if [[ -v KUBE_NAMESPACE ]]; then
    args+=" --namespace=$KUBE_NAMESPACE"
fi

exec $outer_kubectl $args "$@"
